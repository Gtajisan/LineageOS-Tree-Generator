name: Auto LineageOS Tree Generator

on:
  workflow_dispatch:
    inputs:
      DUMP_URL:
        description: 'Git repo URL of the device dump'
        required: true
      DUMP_BRANCH:
        description: 'Branch of the dump repository'
        required: true
      DEVICE_BRAND:
        description: 'Device manufacturer (e.g., xiaomi, samsung)'
        required: true
      CODENAME:
        description: 'Device codename (e.g., daisy, gale)'
        required: true
      GIT_NAME:
        description: 'GitHub account user name'
        required: true
      GIT_EMAIL:
        description: 'GitHub account email address'
        required: true

jobs:
  gen-tree:
    name: Generate and Upload Device Tree
    if: github.event.repository.owner.id == github.event.sender.id
    runs-on: ubuntu-latest

    env:
      DU: ${{ github.event.inputs.DUMP_URL }}
      DUB: ${{ github.event.inputs.DUMP_BRANCH }}
      DB: ${{ github.event.inputs.DEVICE_BRAND }}
      CN: ${{ github.event.inputs.CODENAME }}
      GN: ${{ github.event.inputs.GIT_NAME }}
      GE: ${{ github.event.inputs.GIT_EMAIL }}
      GH_TOKEN: ${{ secrets.LOS }}

    permissions:
      contents: write

    steps:
    - name: Checkout this repo
      uses: actions/checkout@v4

    - name: Install Dependencies
      run: |
        sudo apt update
        sudo apt install -y git python3 python3-pip unzip gh
        pip3 install aospdtgen

    - name: Clone Dump Repository
      run: |
        mkdir -p ~/LOS-Generator
        cd ~/LOS-Generator
        git clone --depth=1 -b "$DUB" "$DU" dump
        echo "Dump cloned to ~/LOS-Generator/dump"

    - name: Generate Device Tree using aospdtgen
      run: |
        cd ~/LOS-Generator/dump
        python3 -m aospdtgen . ../output

    - name: Configure Git
      run: |
        git config --global user.name "$GN"
        git config --global user.email "$GE"

    - name: Create and Push Device Tree to GitHub
      run: |
        cd ~/LOS-Generator/output
        gh auth login --with-token <<< "$GH_TOKEN"
        NEW_REPO="lineage_device_${DB}_${CN}"
        gh repo create "$GN/$NEW_REPO" --public --description "LineageOS tree for $CN" --source=. --remote=origin --push
        git init
        git checkout -b lineage-21
        git add .
        git commit -m "$CN: Initial LineageOS tree generated by aospdtgen"
        git push -u origin lineage-21 --force
        echo "âœ… Device tree pushed to https://github.com/$GN/$NEW_REPO"
