name: Auto LineageOS Tree Generator

on:
  workflow_dispatch:
    inputs:
      DUMP_URL:
        description: 'Dump link'
        required: true
        default: ''
      DUMP_BRANCH:
        description: 'Dump branch'
        required: true
        default: ''
      DEVICE_BRAND:
        description: 'Device manufacturer'
        required: true
        default: ''
      CODENAME:
        description: 'Device codename'
        required: true
        default: ''
      GIT_NAME:
        description: 'GitHub account user name'
        required: true
        default: ''
      GIT_EMAIL:
        description: 'GitHub account email address'
        required: true
        default: ''

jobs:
  gen-tree:
    name: Create LineageOS compatible tree
    if: github.event.repository.owner.id == github.event.sender.id
    runs-on: ubuntu-latest

    env:
      GITHUB_TOKEN: ${{ secrets.LOS }}
      DU: ${{ github.event.inputs.DUMP_URL }}
      DUB: ${{ github.event.inputs.DUMP_BRANCH }}
      DB: ${{ github.event.inputs.DEVICE_BRAND }}
      CN: ${{ github.event.inputs.CODENAME }}
      GN: ${{ github.event.inputs.GIT_NAME }}
      GE: ${{ github.event.inputs.GIT_EMAIL }}

    permissions:
      contents: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Update and install required packages
      run: |
        sudo apt update && sudo apt upgrade -y
        sudo apt install cpio python3 python3-pip git curl -y

    - name: Install GitHub CLI
      run: |
        curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | \
          sudo tee /usr/share/keyrings/githubcli-archive-keyring.gpg > /dev/null
        echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | \
          sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
        sudo apt update
        sudo apt install gh -y

    - name: Clone ROM Dump
      run: |
        mkdir -p ~/LOS-Generator && cd ~/LOS-Generator
        git clone "$DU" -b "$DUB" dump

    - name: Install aospdtgen
      run: |
        pip3 install --upgrade aospdtgen

    - name: Generate LineageOS device tree
      run: |
        cd ~/LOS-Generator/dump
        python3 -m aospdtgen "$(pwd)"
        mv output ~/LOS-Generator/tree

    - name: Configure Git
      run: |
        git config --global user.name "$GN"
        git config --global user.email "$GE"

    - name: Push generated tree to new GitHub repository
      run: |
        cd ~/LOS-Generator/tree
        git init
        git checkout -b lineage-${CN}
        git add .
        git commit -s -m "${CN}: LineageOS compatible device tree"
        echo "${{ secrets.LOS }}" | gh auth login --with-token
        gh repo create "lineage_device_${DB}_${CN}" --public --description "LineageOS compatible device tree for ${CN}" --source=. --remote=origin --push
        echo "âœ… Device tree uploaded successfully!"
